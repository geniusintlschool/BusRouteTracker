<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus No 4 Tracker</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        .error-message {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 4px;
            padding: 12px;
            color: #c62828;
            font-size: 14px;
            z-index: 1001;
            display: none;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
            font-size: 14px;
        }

        .info-panel h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .info-item {
            margin-bottom: 4px;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-live {
            background-color: #4caf50;
        }

        .status-historical {
            background-color: #ff9800;
        }

        /* Custom popup styles */
        .custom-popup {
            font-family: inherit;
        }

        .custom-popup h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 14px;
        }

        .custom-popup p {
            margin: 4px 0;
            color: #666;
            font-size: 12px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .info-panel {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px;
                width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading bus data...</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="info-panel" id="infoPanel">
            <h3>Bus No 4 Tracker</h3>
            <div class="info-item">
                <span class="status-indicator status-live"></span>
                Current Location
            </div>
            <div class="info-item">
                <span class="status-indicator status-historical"></span>
                Historical Route (Jun 25, 3:30-5:30 PM)
            </div>
            <div class="info-item" id="lastUpdate">
                Last Update: Loading...
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        class BusTracker {
            constructor() {
                this.map = null;
                this.currentLocationMarker = null;
                this.routeLayer = null;
                this.stopMarkers = [];
                this.historicalRoute = [];
                
                // API Configuration
                this.ORS_API_KEY = '5b3ce3597851110001cf62486ef5d938c6804787a401d0a56b3236ae';
                this.SHEETS_BASE_URL = 'https://opensheet.elk.sh/1Jnsrz4MoEgjQJ2UjcPB20e4sxd_3TMWAMQ_lq9HAUOs';
                
                // Bus configuration
                this.BUS_NUMBER = 4;
                
                this.initializeMap();
                this.loadBusData();
            }

            initializeMap() {
                // Initialize map centered on a default location (will be adjusted when data loads)
                this.map = L.map('map').setView([28.6139, 77.2090], 13);

                // Add OpenStreetMap tile layer (more reliable)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);
            }

            async loadBusData() {
                try {
                    this.showLoading(true);
                    
                    // Fetch data from all three endpoints
                    const [busLocations, busHistory, busStops] = await Promise.all([
                        this.fetchData(`${this.SHEETS_BASE_URL}/BusLocations`),
                        this.fetchData(`${this.SHEETS_BASE_URL}/BusHistory`),
                        this.fetchData(`${this.SHEETS_BASE_URL}/BusStops`)
                    ]);

                    // Filter data for Bus No 4
                    const bus4Locations = busLocations.filter(bus => parseInt(bus['Bus Number']) === this.BUS_NUMBER);
                    const bus4History = this.filterHistoricalData(busHistory);
                    const bus4Stops = busStops.filter(stop => parseInt(stop['Bus Number']) === this.BUS_NUMBER);

                    console.log(`Found ${bus4Locations.length} current locations for Bus No 4`);
                    console.log(`Found ${bus4Stops.length} bus stops for Bus No 4`);

                    // Process and display data
                    await this.displayCurrentLocation(bus4Locations);
                    await this.displayHistoricalRoute(bus4History);
                    this.displayBusStops(bus4Stops);
                    
                    this.updateLastUpdateTime();
                    this.showLoading(false);
                    
                } catch (error) {
                    console.error('Error loading bus data:', error);
                    this.showError('Failed to load bus data. Please check your internet connection and try again.');
                    this.showLoading(false);
                }
            }

            async fetchData(url) {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            }

            filterHistoricalData(busHistory) {
                // Use data from 6/25/2025 as requested
                const targetDate = '6/25/2025';
                const startHour = 15; // 3:30 PM
                const endHour = 17; // 5:30 PM
                
                const bus4Records = busHistory.filter(record => {
                    return parseInt(record['Bus Number']) === this.BUS_NUMBER;
                });
                
                console.log(`Found ${bus4Records.length} total Bus No 4 records`);
                
                const filteredRecords = bus4Records.filter(record => {
                    const recordTime = record['Time'];
                    if (!recordTime) return false;
                    
                    try {
                        const recordDateStr = recordTime.split(' ')[0]; // Get date part
                        const recordDate = new Date(recordTime);
                        const recordHour = recordDate.getHours();
                        
                        const matches = recordDateStr === targetDate && 
                                       recordHour >= startHour && 
                                       recordHour <= endHour;
                        
                        return matches;
                    } catch (error) {
                        console.warn('Error parsing date:', recordTime, error);
                        return false;
                    }
                });
                
                console.log(`Filtered to ${filteredRecords.length} records for ${targetDate} between ${startHour}:00-${endHour}:00`);
                
                // If no data in specified time range, use any available Bus 4 data from that date
                if (filteredRecords.length === 0) {
                    const dayRecords = bus4Records.filter(record => {
                        const recordTime = record['Time'];
                        return recordTime && recordTime.split(' ')[0] === targetDate;
                    });
                    console.log(`No data in time range, using ${dayRecords.length} records from entire day`);
                    return dayRecords.slice(0, 50); // Limit to 50 points for performance
                }
                
                // Sort by time to ensure proper route order
                filteredRecords.sort((a, b) => {
                    const timeA = new Date(a['Time']);
                    const timeB = new Date(b['Time']);
                    return timeA - timeB;
                });
                
                return filteredRecords;
            }

            async displayCurrentLocation(busLocations) {
                if (busLocations.length === 0) {
                    console.warn('No current location data found for Bus No 4');
                    return;
                }

                // Get the most recent location
                const currentLocation = busLocations[busLocations.length - 1];
                const lat = parseFloat(currentLocation['Latitude']);
                const lng = parseFloat(currentLocation['Longitude']);

                if (isNaN(lat) || isNaN(lng)) {
                    console.warn('Invalid coordinates for current location');
                    return;
                }

                // Create custom yellow bus icon
                const busIcon = L.divIcon({
                    className: 'bus-icon',
                    html: `
                        <div style="
                            background-color: #ffd700;
                            width: 30px;
                            height: 30px;
                            border-radius: 50%;
                            border: 3px solid #fff;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 16px;
                        ">ð</div>
                    `,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                // Add current location marker
                this.currentLocationMarker = L.marker([lat, lng], { icon: busIcon })
                    .addTo(this.map)
                    .bindPopup(`
                        <div class="custom-popup">
                            <h4>Bus No ${this.BUS_NUMBER} - Current Location</h4>
                            <p><strong>Speed:</strong> ${currentLocation['Speed'] || 'N/A'} km/h</p>
                            <p><strong>Ignition:</strong> ${currentLocation['Ignition'] || 'N/A'}</p>
                            <p><strong>Time:</strong> ${currentLocation['Time'] || 'N/A'}</p>
                            <p><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                        </div>
                    `);

                // Center map on current location
                this.map.setView([lat, lng], 15);
            }

            async displayHistoricalRoute(historicalData) {
                // Use the provided filtered route coordinates for Bus No 4
                const routeCoordinates = [
                    [11.707203, 76.178753], [11.707203, 76.178753], [11.707043, 76.178674], [11.703089, 76.176372],
                    [11.70215, 76.175898], [11.699329, 76.174175], [11.698983, 76.173874], [11.69897, 76.173627],
                    [11.69897, 76.173627], [11.693091, 76.175683], [11.693091, 76.175683], [11.693091, 76.175683],
                    [11.692489, 76.171257], [11.692894, 76.169505], [11.690033, 76.163223], [11.690155, 76.162754],
                    [11.690275, 76.162408], [11.69037, 76.161508], [11.690206, 76.160369], [11.690047, 76.163146],
                    [11.690286, 76.163855], [11.691306, 76.165319], [11.691746, 76.166104], [11.691746, 76.166104],
                    [11.691746, 76.166104], [11.691746, 76.166104], [11.691746, 76.166104], [11.691746, 76.166104],
                    [11.68323, 76.1649], [11.68323, 76.1649], [11.679817, 76.16187], [11.674429, 76.158919],
                    [11.674429, 76.158919], [11.673687, 76.157864], [11.673431, 76.156758], [11.670298, 76.150902],
                    [11.672108, 76.148321], [11.672297, 76.147892], [11.672262, 76.148062], [11.66598, 76.157013],
                    [11.665356, 76.158277], [11.665356, 76.158277], [11.663222, 76.160824], [11.658865, 76.16108],
                    [11.657806, 76.160551], [11.65776, 76.160523], [11.65776, 76.160523], [11.653527, 76.154115],
                    [11.65327, 76.143409], [11.652043, 76.142324], [11.651361, 76.141892], [11.651361, 76.141892],
                    [11.638766, 76.145734], [11.638079, 76.147841], [11.636767, 76.149675], [11.631102, 76.150658],
                    [11.623348, 76.156827], [11.619435, 76.15801], [11.619255, 76.158062], [11.61907, 76.158193],
                    [11.619354, 76.167932], [11.619354, 76.167932], [11.617481, 76.160904], [11.619013, 76.158224],
                    [11.619173, 76.158089], [11.629105, 76.152701], [11.62928, 76.15247], [11.638774, 76.145684],
                    [11.639721, 76.14539], [11.640015, 76.145458], [11.650805, 76.141346], [11.649996, 76.140488],
                    [11.649307, 76.137058], [11.649246, 76.134996], [11.649136, 76.132484], [11.648907, 76.128197],
                    [11.64229, 76.110991], [11.641959, 76.110759], [11.641778, 76.110718], [11.641778, 76.110718],
                    [11.641694, 76.110861], [11.63811, 76.101998], [11.636936, 76.10055], [11.63609, 76.0916],
                    [11.634211, 76.090231], [11.634222, 76.090191], [11.634222, 76.090191], [11.636535, 76.097234],
                    [11.637145, 76.100888], [11.641326, 76.109974]
                ];

                console.log(`Displaying route with ${routeCoordinates.length} coordinate points`);

                try {
                    // Attempt to get road-snapped route from OpenRouteService
                    const snappedRoute = await this.getSnappedRoute(routeCoordinates);
                    
                    if (snappedRoute && snappedRoute.length > 0) {
                        console.log(`Got snapped route with ${snappedRoute.length} points`);
                        
                        // Create route polyline using snapped coordinates
                        this.routeLayer = L.polyline(snappedRoute, {
                            color: '#ff9800',
                            weight: 4,
                            opacity: 0.8
                        }).addTo(this.map);

                        // Add popup to route
                        this.routeLayer.bindPopup(`
                            <div class="custom-popup">
                                <h4>Bus No ${this.BUS_NUMBER} - Historical Route</h4>
                                <p><strong>Date:</strong> June 25, 2025</p>
                                <p><strong>Time:</strong> 3:30 PM - 5:30 PM</p>
                                <p><strong>Route Points:</strong> ${routeCoordinates.length}</p>
                                <p><em>Road-snapped route via OpenRouteService</em></p>
                            </div>
                        `);
                    } else {
                        throw new Error('No snapped route returned');
                    }
                } catch (error) {
                    console.warn('Road snapping failed, using GPS coordinates:', error.message);
                    
                    // Fallback: Create route polyline using the filtered coordinates
                    this.routeLayer = L.polyline(routeCoordinates, {
                        color: '#ff9800',
                        weight: 4,
                        opacity: 0.8,
                        dashArray: '10, 5'
                    }).addTo(this.map);

                    // Add popup to route
                    this.routeLayer.bindPopup(`
                        <div class="custom-popup">
                            <h4>Bus No ${this.BUS_NUMBER} - Historical Route</h4>
                            <p><strong>Date:</strong> June 25, 2025</p>
                            <p><strong>Time:</strong> 3:30 PM - 5:30 PM</p>
                            <p><strong>Route Points:</strong> ${routeCoordinates.length}</p>
                            <p><em>GPS trail (road snapping unavailable)</em></p>
                        </div>
                    `);
                }

                // Fit map to show the complete route
                this.map.fitBounds(this.routeLayer.getBounds(), { padding: [20, 20] });
            }

            async getSnappedRoute(coordinates) {
                try {
                    // Convert [lat, lng] to [lng, lat] for OpenRouteService and limit to key points
                    const orsCoords = coordinates
                        .filter((coord, index) => index % 3 === 0 || index === coordinates.length - 1) // Take every 3rd point plus last
                        .slice(0, 25) // Limit to 25 points for API
                        .map(coord => [coord[1], coord[0]]); // Convert to [lng, lat]
                    
                    console.log(`Attempting to snap ${orsCoords.length} waypoints to roads`);
                    
                    const response = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
                        method: 'POST',
                        headers: {
                            'Authorization': this.ORS_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            coordinates: orsCoords,
                            radiuses: orsCoords.map(() => 1000), // 1km radius for snapping each point
                            continue_straight: false
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`ORS API error: ${response.status} - ${errorText}`);
                        throw new Error(`ORS API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const routeGeometry = data.features[0]?.geometry?.coordinates;
                    
                    if (routeGeometry && routeGeometry.length > 0) {
                        // Convert back to [lat, lng] for Leaflet
                        return routeGeometry.map(coord => [coord[1], coord[0]]);
                    }
                    
                    throw new Error('No route geometry returned');
                } catch (error) {
                    console.error('Error getting snapped route:', error);
                    return [];
                }
            }

            // Convert degrees/minutes/seconds to decimal degrees
            convertDMSToDecimal(dmsString) {
                try {
                    // Handle format like "11Â°38'04.3"N " or "76Â°05'24.8"E"
                    // Remove all quotes, extra spaces, and clean the string
                    const cleanString = dmsString.replace(/"/g, '').trim().replace(/\s+/g, '');
                    
                    // Match pattern: degreesÂ°minutes'seconds"direction or degreesÂ°minutes'secondsdirection
                    const parts = cleanString.match(/(\d+)Â°(\d+)'([\d.]+)([NSEW])/);
                    
                    if (!parts) {
                        console.warn('Could not parse DMS string:', dmsString, 'cleaned to:', cleanString);
                        return NaN;
                    }
                    
                    const degrees = parseInt(parts[1]);
                    const minutes = parseInt(parts[2]);
                    const seconds = parseFloat(parts[3]);
                    const direction = parts[4];
                    
                    let decimal = degrees + (minutes / 60) + (seconds / 3600);
                    
                    if (direction === 'S' || direction === 'W') {
                        decimal = -decimal;
                    }
                    
                    return decimal;
                } catch (error) {
                    console.warn('Error converting DMS to decimal:', dmsString, error);
                    return NaN;
                }
            }

            displayBusStops(busStops) {
                console.log(`Processing ${busStops.length} bus stops`);
                
                busStops.forEach((stop, index) => {
                    let lat, lng;
                    
                    // Check if coordinates are in DMS format (contain Â° character)
                    if (stop['Latitude'].includes('Â°')) {
                        lat = this.convertDMSToDecimal(stop['Latitude']);
                        lng = this.convertDMSToDecimal(stop['Longitude']);
                    } else {
                        lat = parseFloat(stop['Latitude']);
                        lng = parseFloat(stop['Longitude']);
                    }

                    if (isNaN(lat) || isNaN(lng)) {
                        console.warn(`Invalid coordinates for stop: ${stop['Stop Name']}`, stop['Latitude'], stop['Longitude']);
                        return;
                    }

                    // Create bus stop icon
                    const stopIcon = L.divIcon({
                        className: 'stop-icon',
                        html: `
                            <div style="
                                background-color: #2196f3;
                                width: 20px;
                                height: 20px;
                                border-radius: 50%;
                                border: 2px solid #fff;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 10px;
                                font-weight: bold;
                            ">${stop['Order'] || index + 1}</div>
                        `,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const marker = L.marker([lat, lng], { icon: stopIcon })
                        .addTo(this.map)
                        .bindPopup(`
                            <div class="custom-popup">
                                <h4>${stop['Stop Name'] || 'Bus Stop'}</h4>
                                <p><strong>Bus Number:</strong> ${stop['Bus Number']}</p>
                                <p><strong>Order:</strong> ${stop['Order'] || index + 1}</p>
                                <p><strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}</p>
                            </div>
                        `);

                    this.stopMarkers.push(marker);
                });
            }

            updateLastUpdateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                document.getElementById('lastUpdate').textContent = `Last Update: ${timeString}`;
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = show ? 'flex' : 'none';
            }

            showError(message) {
                const errorElement = document.getElementById('errorMessage');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 10000);
            }

            // Method to refresh data (can be called externally)
            async refresh() {
                await this.loadBusData();
            }
        }

        // Initialize the bus tracker when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.busTracker = new BusTracker();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                window.busTracker.refresh();
            }, 30000);
        });

        // Telegram Web App specific initialization
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
    </script>
</body>
</html>
